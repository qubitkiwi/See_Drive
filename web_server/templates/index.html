<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI 데이터 전송 폼 (lane_wear_infer)</title>
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter 폰트 사용 설정 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* 오류 메시지 스타일 */
        #response-message {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-xl bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold mb-6 text-gray-800 text-center">
            차량 신고 알림 테스트
        </h1>

        <!-- 응답 메시지 영역 -->
        <div id="response-message" class="hidden p-3 mb-4 rounded-lg font-medium"></div>

        <form id="uploadForm" action="/lane_wear_infer" method="POST" enctype="multipart/form-data" class="space-y-6">

            <!-- 1. 파일 업로드 (File) -->
            <div>
                <label for="file" class="block text-sm font-medium text-gray-700 mb-2">
                    이미지 파일 <span class="text-red-500">*</span>
                </label>
                <input type="file" id="file" name="file" required
                       class="w-full text-sm text-gray-500
                       file:mr-4 file:py-2 file:px-4
                       file:rounded-full file:border-0
                       file:text-sm file:font-semibold
                       file:bg-blue-50 file:text-blue-700
                       hover:file:bg-blue-100 cursor-pointer"/>
            </div>

            <hr class="border-gray-200">

            <!-- 2. GPS 위도 (Form) -->
            <div>
                <label for="gps_lat" class="block text-sm font-medium text-gray-700 mb-2">
                    GPS 위도 (Latitude) <span class="text-red-500">*</span>
                </label>
                <input type="number" step="any" id="gps_lat" name="gps_lat" required
                       placeholder="예: 37.5665"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"/>
            </div>

            <!-- 3. GPS 경도 (Form) -->
            <div>
                <label for="gps_lon" class="block text-sm font-medium text-gray-700 mb-2">
                    GPS 경도 (Longitude) <span class="text-red-500">*</span>
                </label>
                <input type="number" step="any" id="gps_lon" name="gps_lon" required
                       placeholder="예: 126.9780"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"/>
            </div>

            <!-- 4. 타임스탬프 (Form) -->
            <div>
                <label for="timestamp" class="block text-sm font-medium text-gray-700 mb-2">
                    타임스탬프 (Timestamp) <span class="text-red-500">*</span>
                    <span class="text-xs text-gray-400">(YYYY-MM-DDTHH:MM 형식으로 전송됩니다)</span>
                </label>
                <!-- datetime-local은 ISO 8601 형식을 지원하며, FastAPI의 datetime 필드에 적합합니다. -->
                <input type="datetime-local" id="timestamp" name="timestamp" required
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"/>
            </div>

            <!-- 5. 장치 ID (Form) -->
            <div>
                <label for="device_id" class="block text-sm font-medium text-gray-700 mb-2">
                    장치 ID (Device ID) <span class="text-red-500">*</span>
                </label>
                <input type="text" id="device_id" name="device_id" required
                       placeholder="고유 장치 식별자"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"/>
            </div>

            <hr class="border-gray-200">

            <!-- 6. Conf (Query) -->
            <div>
                <label for="conf" class="block text-sm font-medium text-gray-700 mb-2">
                    Confidence Threshold (conf)
                    <span class="text-xs text-gray-400">(Query Parameter, 0.01 ~ 1.0)</span>
                </label>
                <input type="number" step="0.01" min="0.01" max="1.0" id="conf" name="conf" value="0.25"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"/>
            </div>

            <!-- 7. IoU (Query) -->
            <div>
                <label for="iou" class="block text-sm font-medium text-gray-700 mb-2">
                    IoU Threshold (iou)
                    <span class="text-xs text-gray-400">(Query Parameter, 0.05 ~ 0.95)</span>
                </label>
                <input type="number" step="0.01" min="0.05" max="0.95" id="iou" name="iou" value="0.50"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"/>
            </div>

            <!-- 8. Max Size (Query) -->
            <div>
                <label for="max_size" class="block text-sm font-medium text-gray-700 mb-2">
                    최대 이미지 크기 (max_size)
                    <span class="text-xs text-gray-400">(Query Parameter, 320 ~ 4096)</span>
                </label>
                <input type="number" min="320" max="4096" id="max_size" name="max_size" value="1280"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"/>
            </div>

            <!-- 전송 버튼 -->
            <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg
                           shadow-lg hover:shadow-xl transform hover:scale-[1.01] transition duration-300 ease-in-out">
                데이터 전송
            </button>
        </form>

        <p class="text-xs text-center text-gray-400 mt-6">
            모든 필수 필드(<span class="text-red-500">*</span>)를 입력해야 합니다.
        </p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const form = document.getElementById('uploadForm');
            const messageDiv = document.getElementById('response-message');

            function showMessage(text, isError = false) {
                messageDiv.textContent = text;
                messageDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
                if (isError) {
                    messageDiv.classList.add('bg-red-100', 'text-red-700');
                } else {
                    messageDiv.classList.add('bg-green-100', 'text-green-700');
                }
            }

            // 폼 제출 시 실제 HTTP 요청을 시뮬레이션하고 결과를 표시합니다.
            // (주의: 이 코드는 실제 FastAPI 서버가 실행되고 있지 않다면 "Failed to fetch" 오류를 발생시킵니다.)
            form.addEventListener('submit', async function(e) {
                e.preventDefault(); // 기본 폼 제출 방지

                const formData = new FormData(form);

                // Query Parameters를 URL에 직접 추가하여 FastAPI의 @app.post 경로를 재구성
                const conf = formData.get('conf');
                const iou = formData.get('iou');
                const maxSize = formData.get('max_size');

                // Form Data에서 Query 매개변수 제거 (FastAPI는 이들을 URL에서 기대하므로)
                formData.delete('conf');
                formData.delete('iou');
                formData.delete('max_size');

                // FastAPI 서버 URL 구성
                const baseUrl = form.action;
                const fullUrl = `${baseUrl}?conf=${conf}&iou=${iou}&max_size=${maxSize}`;

                messageDiv.textContent = '데이터를 서버로 전송 중...';
                messageDiv.classList.remove('hidden');
                messageDiv.classList.add('bg-blue-100', 'text-blue-700');

                try {
                    const response = await fetch(fullUrl, {
                        method: 'POST',
                        body: formData // multipart/form-data 본문 전송
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('성공 응답:', result);
                        showMessage(`전송 성공! 서버 응답: ${JSON.stringify(result).substring(0, 100)}...`, false);
                        form.reset();
                    } else {
                        const errorText = await response.text();
                        console.error('전송 실패 응답:', response.status, errorText);
                        showMessage(`전송 실패 (상태 코드: ${response.status}). 응답 내용: ${errorText.substring(0, 100)}...`, true);
                    }
                } catch (error) {
                    console.error('네트워크 오류:', error);
                    showMessage(`네트워크 오류 발생: FastAPI 서버가 실행 중인지 확인하세요.`, true);
                }
            });
        });
    </script>
</body>
</html>